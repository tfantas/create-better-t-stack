name: Dev Publish

on:
  push:
    branches:
      - preview-template
  workflow_dispatch:

jobs:
  publish-dev:
    name: Publish Dev Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile
        env:
          BTS_TELEMETRY: 0

      - name: Generate Dev Version
        id: version
        run: |
          COMMIT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          BASE_VERSION=$(jq -r '.version' apps/cli/package.json | sed -E 's/^([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          DEV_VERSION="${BASE_VERSION}-dev.${COMMIT_SHA}"
          NPM_TAG="dev"

          echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$NPM_TAG" >> $GITHUB_OUTPUT

          echo "Dev version: $DEV_VERSION"
          echo "NPM tag: $NPM_TAG"

      - name: Update types package version
        run: |
          cd packages/types
          jq --arg v "${{ steps.version.outputs.version }}" '.version = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Build types package
        run: cd packages/types && bun run build

      - name: Publish types to NPM
        run: cd packages/types && bun publish --access public --tag ${{ steps.version.outputs.tag }}
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
          BTS_TELEMETRY: 0

      - name: Update template-generator package version and types dependency
        run: |
          cd packages/template-generator
          jq --arg v "${{ steps.version.outputs.version }}" '.version = $v | .dependencies["@better-t-stack/types"] = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Build template-generator package
        run: cd packages/template-generator && bun run build

      - name: Publish template-generator to NPM
        run: cd packages/template-generator && bun publish --access public --tag ${{ steps.version.outputs.tag }}
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
          BTS_TELEMETRY: 0

      - name: Update CLI package version and dependencies
        run: |
          cd apps/cli
          jq --arg v "${{ steps.version.outputs.version }}" '.version = $v | .dependencies["@better-t-stack/types"] = $v | .dependencies["@better-t-stack/template-generator"] = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Update create-bts alias package version
        run: |
          cd packages/create-bts
          jq --arg v "${{ steps.version.outputs.version }}" '.version = $v | .dependencies["create-better-t-stack"] = $v' package.json > tmp.json && mv tmp.json package.json

      - name: Build CLI
        run: cd apps/cli && bun run build
        env:
          BTS_TELEMETRY: 0

      - name: Publish CLI to NPM
        run: cd apps/cli && bun publish --access public --tag ${{ steps.version.outputs.tag }}
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
          BTS_TELEMETRY: 0

      - name: Publish create-bts to NPM
        run: cd packages/create-bts && bun publish --access public --tag ${{ steps.version.outputs.tag }}
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
          BTS_TELEMETRY: 0

      - name: Output Published Versions
        run: |
          echo "## Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Version | NPM Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`@better-t-stack/types\` | \`${{ steps.version.outputs.version }}\` | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`@better-t-stack/template-generator\` | \`${{ steps.version.outputs.version }}\` | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`create-better-t-stack\` | \`${{ steps.version.outputs.version }}\` | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`create-bts\` | \`${{ steps.version.outputs.version }}\` | \`${{ steps.version.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "bunx create-better-t-stack@dev" >> $GITHUB_STEP_SUMMARY
          echo "npx create-better-t-stack@dev" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
