<script setup lang="ts">
import { Chat } from '@ai-sdk/vue'
import type { UIMessage } from 'ai'
import { getTextFromMessage } from '@nuxt/ui/utils/ai'
import { DefaultChatTransport } from 'ai'
import { ref } from 'vue'

const config = useRuntimeConfig()
const messages: UIMessage[] = []
const input = ref('')

const chat = new Chat({
  messages,
  transport: new DefaultChatTransport({
    api: `${config.public.serverUrl}/ai`,
  }),
  onError(error) {
    console.error('Chat error:', error)
  }
})

async function handleSubmit(e: Event) {
  e.preventDefault()
  const userInput = input.value
  input.value = ''

  if (!userInput.trim()) return

  chat.sendMessage({ text: userInput })
}
</script>

<template>
  <UContainer class="h-full flex flex-col overflow-hidden py-4">
    <div class="flex-1 min-h-0 overflow-y-auto">
      <UChatMessages :messages="chat.messages" :status="chat.status">
        <template #content="{ message }">
          <div class="whitespace-pre-wrap">\{{ getTextFromMessage(message) }}</div>
        </template>
      </UChatMessages>
    </div>

    <div class="shrink-0 pt-4 border-t border-gray-200 dark:border-gray-800">
      <UChatPrompt
        v-model="input"
        :error="chat.error"
        @submit="handleSubmit"
        placeholder="Type your message..."
      >
        <UChatPromptSubmit :status="chat.status" @stop="() => chat.stop()" @reload="() => chat.regenerate()" />
      </UChatPrompt>
    </div>
  </UContainer>
</template>