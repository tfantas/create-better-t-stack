import { Text, View } from "react-native";
import { Container } from "@/components/container";
{{#if (eq api "orpc")}}
import { useQuery } from "@tanstack/react-query";
import { orpc } from "@/utils/orpc";
{{/if}}
{{#if (eq api "trpc")}}
import { useQuery } from "@tanstack/react-query";
import { trpc } from "@/utils/trpc";
{{/if}}
{{#if (and (eq backend "convex") (eq auth "clerk"))}}
import { Link } from "expo-router";
import { Authenticated, AuthLoading, Unauthenticated, useQuery } from "convex/react";
import { api } from "@{{projectName}}/backend/convex/_generated/api";
import { useUser } from "@clerk/clerk-expo";
import { SignOutButton } from "@/components/sign-out-button";
{{else if (and (eq backend "convex") (eq auth "better-auth"))}}
import { useConvexAuth, useQuery } from "convex/react";
import { api } from "@{{projectName}}/backend/convex/_generated/api";
import { authClient } from "@/lib/auth-client";
import { SignIn } from "@/components/sign-in";
import { SignUp } from "@/components/sign-up";
{{else if (eq backend "convex")}}
import { useQuery } from "convex/react";
import { api } from "@{{projectName}}/backend/convex/_generated/api";
{{/if}}
{{#unless (or (eq backend "none") (and (eq backend "convex") (eq auth "better-auth")))}}
import { Ionicons } from "@expo/vector-icons";
{{/unless}}
import { Button, Chip, Divider, Spinner, Surface, useThemeColor } from "heroui-native";

export default function Home() {
{{#if (eq api "orpc")}}
const healthCheck = useQuery(orpc.healthCheck.queryOptions());
{{/if}}
{{#if (eq api "trpc")}}
const healthCheck = useQuery(trpc.healthCheck.queryOptions());
{{/if}}
{{#if (and (eq backend "convex") (eq auth "clerk"))}}
const { user } = useUser();
const healthCheck = useQuery(api.healthCheck.get);
const privateData = useQuery(api.privateData.get);
{{else if (and (eq backend "convex") (eq auth "better-auth"))}}
const healthCheck = useQuery(api.healthCheck.get);
const { isAuthenticated } = useConvexAuth();
const user = useQuery(api.auth.getCurrentUser, isAuthenticated ? {} : "skip");
{{else if (eq backend "convex")}}
const healthCheck = useQuery(api.healthCheck.get);
{{/if}}
{{#unless (eq backend "none")}}
const successColor = useThemeColor("success");
const dangerColor = useThemeColor("danger");

{{#if (eq backend "convex")}}
const isConnected = healthCheck === "OK";
const isLoading = healthCheck === undefined;
{{else}}
{{#unless (eq api "none")}}
const isConnected = healthCheck?.data === "OK";
const isLoading = healthCheck?.isLoading;
{{/unless}}
{{/if}}
{{/unless}}

return (
<Container className="p-4">
  <View className="py-6 mb-4">
    <Text className="text-3xl font-semibold text-foreground tracking-tight">
      Better T Stack
    </Text>
    <Text className="text-muted text-sm mt-1">Full-stack TypeScript starter</Text>
  </View>

  {{#unless (or (eq backend "none") (and (eq backend "convex") (eq auth "better-auth")))}}
  <Surface variant="secondary" className="p-4 rounded-lg">
    <View className="flex-row items-center justify-between mb-3">
      <Text className="text-foreground font-medium">System Status</Text>
      <Chip variant="secondary" color={isConnected ? "success" : "danger" } size="sm">
        <Chip.Label>
          {isConnected ? "LIVE" : "OFFLINE"}
        </Chip.Label>
      </Chip>
    </View>

    <Divider className="mb-3" />

    <Surface variant="tertiary" className="p-3 rounded-md">
      <View className="flex-row items-center">
        <View className={`w-2 h-2 rounded-full mr-3 ${ isConnected ? "bg-success" : "bg-muted" }`} />
        <View className="flex-1">
          <Text className="text-foreground text-sm font-medium">
            {{#if (eq backend "convex")}}
            Convex Backend
            {{else}}
            {{#unless (eq api "none")}}
            {{#if (eq api "orpc")}}ORPC{{else}}TRPC{{/if}} Backend
            {{/unless}}
            {{/if}}
          </Text>
          <Text className="text-muted text-xs mt-0.5">
            {isLoading
            ? "Checking connection..."
            : isConnected
            ? "Connected to API"
            : "API Disconnected"}
          </Text>
        </View>
        {isLoading && <Spinner size="sm" />}
        {!isLoading && isConnected && (
        <Ionicons name="checkmark-circle" size={18} color={successColor} />
        )}
        {!isLoading && !isConnected && (
        <Ionicons name="close-circle" size={18} color={dangerColor} />
        )}
      </View>
    </Surface>
  </Surface>
  {{/unless}}

  {{#if (and (eq backend "convex") (eq auth "clerk"))}}
  <Authenticated>
    <Surface variant="secondary" className="mt-4 p-4 rounded-lg">
      <View className="flex-row items-center justify-between">
        <View className="flex-1">
          <Text className="text-foreground font-medium">{user?.emailAddresses[0].emailAddress}</Text>
          <Text className="text-muted text-xs mt-0.5">Private: {privateData?.message}</Text>
        </View>
        <SignOutButton />
      </View>
    </Surface>
  </Authenticated>
  <Unauthenticated>
    <View className="mt-4 gap-3">
      <Link href="/(auth)/sign-in" asChild>
        <Button variant="secondary"><Button.Label>Sign In</Button.Label></Button>
      </Link>
      <Link href="/(auth)/sign-up" asChild>
        <Button variant="ghost"><Button.Label>Sign Up</Button.Label></Button>
      </Link>
    </View>
  </Unauthenticated>
  <AuthLoading>
    <View className="mt-4 items-center">
      <Spinner size="sm" />
    </View>
  </AuthLoading>
  {{/if}}

  {{#if (and (eq backend "convex") (eq auth "better-auth"))}}
  {user ? (
  <Surface variant="secondary" className="mb-4 p-4 rounded-lg">
    <View className="flex-row items-center justify-between">
      <View className="flex-1">
        <Text className="text-foreground font-medium">{user.name}</Text>
        <Text className="text-muted text-xs mt-0.5">{user.email}</Text>
      </View>
      <Button
        variant="destructive"
        size="sm"
        onPress={() => {
          authClient.signOut();
        }}
      >
        Sign Out
      </Button>
    </View>
  </Surface>
  ) : null}
  <Surface variant="secondary" className="p-4 rounded-lg">
    <Text className="text-foreground font-medium mb-2">API Status</Text>
    <View className="flex-row items-center gap-2">
      <View className={`w-2 h-2 rounded-full ${healthCheck==="OK" ? "bg-success" : "bg-danger" }`} />
      <Text className="text-muted text-xs">
        {healthCheck === undefined
        ? "Checking..."
        : healthCheck === "OK"
        ? "Connected to API"
        : "API Disconnected"}
      </Text>
    </View>
  </Surface>
  {!user && (
  <View className="mt-4 gap-4">
    <SignIn />
    <SignUp />
  </View>
  )}
  {{/if}}
</Container>
);
}